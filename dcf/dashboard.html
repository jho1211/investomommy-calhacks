#dashboard.html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DCF Dashboard (Standalone)</title>
  <style>
    :root{
      /* —— Light / Green palette —— */
      --bg: #ffffff;            /* page background */
      --panel: #f7f9fb;         /* panels / sections */
      --card: #f7f9fb;          /* KPI tiles */
      --text: #212529;          /* primary text */
      --muted: #6c757d;         /* secondary text */
      --border: #dee2e6;        /* subtle borders */
      --good: #0e8b5d;          /* green accent (positive) */
      --bad: #dc3545;           /* red accent (negative) */
      --accent: #0e8b5d;        /* primary accent for buttons/focus */
      --accent-weak: #cfe8db;   /* light green tint for focus bg */
    }

    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:15.5px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial
    }

    .container{max-width:1120px;margin:18px auto;padding:0 16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    /* Inputs / buttons */
    .input{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      min-width:120px;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-weak);
    }

    .btn{
      background:var(--accent);
      color:#fff;
      border:1px solid var(--accent);
      border-radius:10px;
      padding:10px 14px;
      cursor:pointer;
      transition:filter .15s ease, box-shadow .15s ease;
    }
    .btn:hover{ filter:brightness(0.95); }
    .btn:focus{
      outline:none;
      box-shadow:0 0 0 3px var(--accent-weak);
    }

    .tag{
      display:inline-block;
      background:#fff;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      padding:3px 8px;
      border-radius:999px
    }
    .muted{color:var(--muted)}

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.05)
    }

    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin:12px 0}
    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px
    }
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:22px;font-weight:700}
    .kpi .sub{font-size:12px;margin-top:4px}
    .kpi.up .value{font-size:24px}

    .caption{color:var(--muted);font-size:13px;margin-top:8px}
    .grid{width:100%}
    .legend{font-size:12px;color:var(--muted)}

    /* Table: light borders & crisp header */
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border)}
    th{background:#ffffff;color:#495057;text-align:left;font-weight:600}
    .right{text-align:right}

    @media (max-width: 980px){.kpis{grid-template-columns:repeat(3,1fr)}}
    @media (max-width: 640px){.kpis{grid-template-columns:repeat(2,1fr)}}
    @media (max-width: 420px){.kpis{grid-template-columns:1fr}}
  </style>
  <!-- React 18 + Plotly (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>
<body>
  <div class="container">
    <h2 style="margin:0 0 6px 0">DCF Dashboard</h2>
    <div class="muted">Beginner-friendly, ticker-agnostic. KPI bar → sensitivity heatmap → static explanation.</div>
    <div id="app" style="margin-top:14px"></div>
  </div>

<script>
(function(){
  const e = React.createElement;

  // ========= math utilities (DCF, midyear) =========
  function fmtUSD(x, short=false){
    if(x==null || !isFinite(+x)) return '—';
    const n=+x; return short? `$${(n/1e9).toFixed(1)}B` : `$${n.toLocaleString(undefined,{maximumFractionDigits:0})}`;
  }
  function fmtPct(x){
    if(x==null || !isFinite(+x)) return '—';
    return (x*100).toFixed(2)+'%';
  }
  function fmtPct0(x){ if(x==null||!isFinite(+x)) return '—'; return (x*100).toFixed(1)+'%'; }

  // Discount factors for constant WACC with midyear convention
  function discountFactorsConst(r, n, midyear){
    const dfs=[]; for(let t=1;t<=n;t++){ const expo = midyear? (t-0.5): t; dfs.push( Math.pow(1+r, -expo) ); }
    return dfs;
  }
  function terminalValue(lastFCFF, r, g){ return (lastFCFF*(1+g)) / Math.max(r-g, 1e-9); }
  function dcfValuePerShare({fcff, wacc, g, midyear=true, cash=0, debt=0, shares}){
    const n=fcff.length; const dfs=discountFactorsConst(wacc,n,midyear);
    let pvExplicit=0; for(let i=0;i<n;i++){ pvExplicit += fcff[i]*dfs[i]; }
    const tv = terminalValue(fcff[n-1], wacc, g);
    const tvDf = Math.pow(1+wacc, -(n-(midyear?0.5:0)));
    const pvTv = tv*tvDf; const ev=pvExplicit+pvTv; const eq=ev + (cash||0) - (debt||0);
    const ivps = (shares && shares>0)? eq/shares : null;
    return {pvExplicit, pvTv, ev, eq, ivps, tv};
  }

  // Build sensitivity grid around base (3x3 by default)
  function buildHeatmap({fcff, cash, debt, shares, baseWacc, baseG, midyear=true, stepWacc=0.015, stepG=0.005}){
    const waccAxis=[Math.max(0.03, baseWacc-stepWacc), baseWacc, Math.min(0.20, baseWacc+stepWacc)];
    const gAxis=[Math.max(0.01, baseG-stepG), baseG, Math.min(0.06, baseG+stepG)];
    const grid = waccAxis.map(w=> gAxis.map(g=>{
      const {ivps} = dcfValuePerShare({fcff,wacc:w,g,midyear,cash,debt,shares});
      return ivps!=null && isFinite(+ivps)? +ivps : null;
    }));
    return {grid, waccAxis, gAxis, basePos:{row:1,col:1}}; // middle cell is base
  }

  // ========= UI components =========
  function Heatmap({grid,waccAxis,gAxis,basePos}){
    React.useEffect(()=>{
      const z = grid && grid.length? grid : [[null]];
      const x = (gAxis||[]).map(g=> (typeof g==='number')? (g*100).toFixed(2)+'%': g);
      const y = (waccAxis||[]).map(w=> (typeof w==='number')? (w*100).toFixed(2)+'%': w);

      // z-range for better contrast
      let zmin, zmax; if(Array.isArray(grid) && grid.length){
        const flat = grid.flat().filter(v=>typeof v==='number');
        if(flat.length){ zmin=Math.min(...flat); zmax=Math.max(...flat); }
      }

      const annotations=[];
      // numeric labels in cells (dark text for light bg)
      for(let r=0;r<z.length;r++){
        for(let c=0;c<z[r].length;c++){
          const v=z[r][c]; if(v==null) continue;
          annotations.push({x:x[c],y:y[r],text:`$${Math.round(v)}`,showarrow:false,font:{size:12,color:'#212529'}});
        }
      }
      // base assumption callout (green accent)
      if(basePos && z[basePos.row] && isFinite(z[basePos.row][basePos.col])){
        annotations.push({
          x:x[basePos.col], y:y[basePos.row], text:'Base Assumption',
          showarrow:true, ax:0, ay:-35,
          bgcolor:'#e9f5ef', bordercolor:'#0e8b5d', font:{size:12,color:'#0e8b5d'}
        });
      }

      const data=[{
        type:'heatmap',
        z, zmin, zmax, x, y,
        colorscale:'Viridis',
        hovertemplate:'WACC %{y}<br>g %{x}<br>IV $%{z:.0f}<extra></extra>',
        colorbar:{title:'IV / Share (USD)'}
      }];

      const layout={
        template:'plotly_white',                     // light theme
        paper_bgcolor:'#f7f9fb',                    // panel color
        plot_bgcolor:'#f7f9fb',
        margin:{l:70,r:20,t:10,b:60},
        height:520,
        xaxis:{title:'Terminal Growth (g)', gridcolor:'#e9ecef', zerolinecolor:'#e9ecef'},
        yaxis:{title:'WACC', gridcolor:'#e9ecef', zerolinecolor:'#e9ecef'},
        font:{color:'#212529'},
        annotations
      };

      Plotly.react('heatmap', data, layout, {displaylogo:false,responsive:true});
    }, [grid,waccAxis,gAxis,basePos]);
    return e('div',{id:'heatmap',className:'grid'});
  }

  function App(){
    // You can change apiBase if your backend runs elsewhere
    const [apiBase,setApiBase]=React.useState('http://127.0.0.1:8001');
    const [ticker,setTicker]=React.useState('AAPL');
    const [status,setStatus]=React.useState('');

    // dynamic inputs + raw data needed for correct math
    const [price,setPrice]=React.useState(null);
    const [ivBase,setIvBase]=React.useState(null);
    const [ivDyn,setIvDyn]=React.useState(null);
    const [waccBase,setWaccBase]=React.useState(null);
    const [gBase,setGBase]=React.useState(null);

    const [fcff,setFcff]=React.useState([]);
    const [cash,setCash]=React.useState(0);
    const [debt,setDebt]=React.useState(0);
    const [shares,setShares]=React.useState(null);
    const [midyear,setMidyear]=React.useState(true);

    const fetchIt=async()=>{
      try{
        setStatus('Fetching…');
        const url=`${apiBase.replace(/\/$/,'')}/api/dcf/${ticker.toUpperCase()}?years=10&midyear=true&debug=true`;
        const r=await fetch(url,{mode:'cors'});
        if(!r.ok) throw new Error(r.status+' '+r.statusText);
        const j=await r.json();

        // pull fields from backend; then recompute base IV locally for correctness
        const price0=j?.financials_snapshot?.totals?.price ?? null;
        const ivB0=j?.valuation?.base_constant_wacc?.intrinsic_value_per_share ?? null;
        const ivD0=j?.valuation?.dynamic_wacc?.intrinsic_value_per_share ?? null;
        const w0=j?.assumptions?.wacc_base ?? null;
        const g0=j?.assumptions?.terminal_growth_used ?? null;
        const fcff0=j?.fcff_projection ?? [];
        const cash0=j?.financials_snapshot?.totals?.cash_and_st_invest ?? 0;
        const debt0=j?.financials_snapshot?.totals?.total_debt ?? 0;
        const sh0=j?.financials_snapshot?.totals?.shares_out ?? null;

        setPrice(price0); setIvBase(ivB0); setIvDyn(ivD0); setWaccBase(w0); setGBase(g0);
        setFcff(Array.isArray(fcff0)? fcff0.map(Number): []);
        setCash(Number(cash0)||0); setDebt(Number(debt0)||0); setShares(Number(sh0)||null); setMidyear(true);

        // validate math locally (recompute base IV from raw inputs)
        if(Array.isArray(fcff0) && fcff0.length && w0!=null && g0!=null && sh0){
          const {ivps} = dcfValuePerShare({fcff:fcff0.map(Number), wacc:w0, g:g0, midyear:true, cash:cash0, debt:debt0, shares:sh0});
          if(isFinite(+ivps) && isFinite(+ivB0)){
            const err = Math.abs(ivps - ivB0) / Math.max(1, Math.abs(ivB0));
            setStatus(err>0.02? `Fetched OK, note: local base IV differs by ${(err*100).toFixed(1)}%` : 'OK');
          } else {
            setStatus('OK');
          }
        } else {
          setStatus('OK');
        }
      }catch(err){
        console.error(err); setStatus('Fetch failed: '+err);
      }
    };

    React.useEffect(()=>{ fetchIt(); },[]);

    // KPI: Upside vs Current Price (uses Base IV)
    const upsidePct = (price!=null && ivBase!=null)? ((ivBase/price)-1)*100 : null;

    // Heatmap computed locally from raw fcff, not trusting the backend grid
    const heat = (fcff.length && waccBase!=null && gBase!=null && shares)?
      buildHeatmap({fcff, cash, debt, shares, baseWacc:waccBase, baseG:gBase, midyear:true, stepWacc:0.015, stepG:0.005})
      : {grid:[[null]], waccAxis:[], gAxis:[], basePos:{row:1,col:1}};

    return e(React.Fragment,null,[
      e('div',{className:'row',style:{marginBottom:'10px'}},[
        e('input',{className:'input',value:ticker,onChange:ev=>setTicker(ev.target.value),placeholder:'Ticker (e.g., AAPL)'}),
        e('button',{className:'btn',onClick:fetchIt},'Fetch'),
        e('span',{className:'muted',style:{marginLeft:8}},status||'') ,
        e('span',{className:'tag'},`${apiBase}/api/dcf/${ticker.toUpperCase()}`)
      ]),

      // ===== Top KPI Bar (five tiles) =====
      e('div',{className:'kpis'},[
        e('div',{className:'kpi'},[
          e('div',{className:'label'},'Intrinsic Value (Base)'),
          e('div',{className:'value'}, fmtUSD(ivBase))
        ]),
        e('div',{className:'kpi'},[
          e('div',{className:'label'},'Intrinsic Value (Dynamic)'),
          e('div',{className:'value'}, fmtUSD(ivDyn))
        ]),
        e('div',{className:'kpi up'},[
          e('div',{className:'label'},'Upside vs Current Price'),
          e('div',{className:'value',style:{color:(upsidePct!=null && upsidePct>=0)? 'var(--good)':'var(--bad)'}},
            upsidePct==null? '—' : (upsidePct.toFixed(1)+'%')
          ),
          e('div',{className:'sub'}, ['Current Price ', fmtUSD(price)])
        ]),
        e('div',{className:'kpi'},[
          e('div',{className:'label'},'WACC'),
          e('div',{className:'value'}, fmtPct0(waccBase))
        ]),
        e('div',{className:'kpi'},[
          e('div',{className:'label'},'Terminal Growth (g)'),
          e('div',{className:'value'}, fmtPct0(gBase))
        ])
      ]),

      // ===== Sensitivity Heatmap =====
      e('div',{className:'panel',style:{marginTop:'4px'}},[
        e('h4',{style:{margin:'6px 0'}},'Sensitivity Heatmap — Intrinsic Value / Share'),
        e('div',{className:'legend'},'Y: WACC  |  X: Terminal Growth (g)'),
        e(Heatmap,{grid:heat.grid, waccAxis:heat.waccAxis, gAxis:heat.gAxis, basePos:heat.basePos}),
        e('div',{className:'caption'},
          'This heatmap tests “what-if” scenarios, showing how the valuation changes when your WACC and Terminal Growth assumptions change. The highlighted middle cell is the Base Assumption.'
        )
      ]),

      // ===== Educational Section (static, reusable) =====
      e('div',{className:'panel',style:{marginTop:'12px'}},[
        e('h3',null,'Educational Explanation (Reusable Across All Tickers)'),

        e('h4',{style:{margin:'12px 0 6px 0'}},'What This Dashboard Shows'),
        e('p',{className:'muted'},
          'The Discounted Cash Flow (DCF) model estimates a company’s “true worth” based on the cash it is expected to generate in the future. At the top, Intrinsic Value represents that estimate. We compare Intrinsic Value to the current stock price to see potential undervaluation or overvaluation (shown as Upside). If the value is well above the price, the stock may be undervalued under the current assumptions; if it is below, it may be overvalued.'
        ),

        e('h4',{style:{margin:'12px 0 6px 0'}},'How the DCF Works'),
        e('ul',{className:'muted'},[
          e('li',null,'Core idea: Value = present value of all expected future cash.'),
          e('li',null,'Discount Rate (WACC): higher WACC means more risk → lower valuation; lower WACC means less risk → higher valuation.'),
          e('li',null,'Terminal Growth (g): higher long-run growth expectations → higher valuation.'),
        ]),

        e('h4',{style:{margin:'12px 0 6px 0'}},'What Is Unlevered Free Cash Flow (FCF)?'),
        e('p',{className:'muted'}, 'Unlevered FCF is the cash available to all investors (debt and equity) before debt payments. It reflects performance from core operations, not financing decisions.'),
        e('table',null,[
          e('thead',null,e('tr',null,[
            e('th',null,'Component'), e('th',null,'Definition')
          ])),
          e('tbody',null,[
            e('tr',null,[e('td',null,'Revenue'), e('td',null,'Total sales generated by the company.')]),
            e('tr',null,[e('td',null,'COGS & Operating Expenses'), e('td',null,'The cost to produce goods and run the business.')]),
            e('tr',null,[e('td',null,'Taxes'), e('td',null,'Government payments based on income.')]),
            e('tr',null,[e('td',null,'Depreciation & Amortization'), e('td',null,'Accounting for wear-and-tear on long-term assets.')]),
            e('tr',null,[e('td',null,'Change in Working Capital'), e('td',null,'Adjusts for timing differences in cash collections and payments.')]),
            e('tr',null,[e('td',null,'Capital Expenditures (CapEx)'), e('td',null,'Money spent on equipment, infrastructure, or technology.')]),
          ])
        ]),
        e('p',{className:'muted'},
          'Ignored in Unlevered FCF: Interest Expense, Other Income/Expense, most one-time non-cash items, most of the Cash Flow from Investing (CFI) section, and all of the Cash Flow from Financing (CFF) section.'
        ),

        e('h4',{style:{margin:'12px 0 6px 0'}},'Why the Heatmap Matters'),
        e('ul',{className:'muted'},[
          e('li',null,'The colorful grid shows how sensitive valuation is to small changes in assumptions.'),
          e('li',null,'Moving right (higher g) = more optimistic outlook → higher value.'),
          e('li',null,'Moving up (higher WACC) = more risk → lower value.'),
          e('li',null,'Valuation is a range of possibilities, not a single exact number — the heatmap makes this range visible.'),
        ])
      ])
    ]);
  }

  const root = ReactDOM.createRoot(document.getElementById('app'));
  root.render(React.createElement(App));
})();
</script>
</body>
</html>
